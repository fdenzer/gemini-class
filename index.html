<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURPS Interactive Shipyard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: The application is designed as a "Shipyard Workbench" with a task-oriented structure to streamline the complex process of ship design from the GURPS Spaceships rules. The layout consists of four main interactive panels: 1) Configuration, where the user sets the foundational Hull Size (SM) and Tech Level (TL), which dictates all subsequent stats. 2) System Catalog, an organized and filterable library of all ship components, now with category filters for quick navigation. 3) Ship Blueprint, a visual representation of the ship's sections and slots where users place systems via drag-and-drop. 4) Live Dashboard, which provides immediate, dynamic feedback on key statistics like cost, power, and performance. This structure was chosen because it transforms the static, data-heavy tables of the report into an interactive workflow, automating calculations and allowing for rapid prototyping and iteration, which is the primary goal for a player or GM using these rules. Navigation allows switching to a "Rules Reference" and "Example Ships" section for contextual information without losing the design state. -->
    <!-- Visualization & Content Choices: The application uses a mix of interactive elements to make the data consumable. 1) Ship Blueprint (HTML/CSS Diagram): Goal: Organize. This visually represents the core design concept of the report—placing 20 systems into specific hull locations. It's interactive, allowing users to add/remove systems via drag-and-drop, providing a hands-on design experience. 2) Live Stats Dashboard (Dynamic Text & Charts): Goal: Inform & Compare. This is the core feedback loop. It displays critical stats that change instantly with user actions. It includes two charts: a doughnut chart for Cost Breakdown (comparing investment in different areas like armor vs. weapons) and a radar chart for Performance Profile (giving a holistic, at-a- glance view of the ship's capabilities). Library: Chart.js/Canvas. 3) System Catalog (Interactive List with Filters): Goal: Organize & Inform. Presents the vast catalog of ship systems from the report in a filterable, user-friendly format, showing stats relevant to the user's current hull and TL selection. Justification: This combination of interactive diagram, dynamic dashboard, and filterable catalog directly supports the user's primary task of designing a balanced and functional spacecraft according to the source material's rules. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        /* CSS Variables for theming */
        :root {
            /* Light Theme */
            --color-bg-primary: #FDFBF7; /* Warm Neutral: A very light, warm beige */
            --color-bg-secondary: #FFFFFF;
            --color-bg-tertiary: #F1F5F9; /* Slate 100 */
            --color-text-base: #334155; /* Slate 700 */
            --color-text-heading: #1E293B; /* Slate 800 */
            --color-text-muted: #64748B; /* Slate 500 */
            --color-border-light: #CBD5E1; /* Slate 300 */
            --color-border-medium: #94A3B8; /* Slate 400 */
            --color-accent-primary: #F59E0B; /* Amber 500 */
            --color-accent-secondary: #0d9488; /* Teal 600 */
            --color-accent-tertiary: #ccfbf1; /* Teal 50 */
            --color-accent-hover: #fde68a; /* Amber 200 */
            --color-button-primary-bg: #0d9488; /* Teal 600 */
            --color-button-primary-hover-bg: #14b8a6; /* Teal 500 */
            --color-button-danger-bg: #ef4444; /* Red 500 */
            --color-button-danger-hover-bg: #dc2626; /* Red 600 */
            --color-button-neutral-bg: #64748B; /* Slate 500 */
            --color-button-neutral-hover-bg: #475569; /* Slate 700 */
            --color-input-border: #CBD5E1; /* Slate 300 */
            --color-input-focus-ring: #0d9488; /* Teal 600 */
            --color-stat-primary: #0d9488; /* Teal 600 */
            --color-stat-secondary: #334155; /* Slate 700 */
            --color-error: #ef4444; /* Red 500 */
            --color-success: #22c55e; /* Green 500 */
            --color-info: #3b82f6; /* Blue 500 */
        }

        /* Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #1A202C; /* Dark Slate */
                --color-bg-secondary: #2D3748; /* Darker Slate */
                --color-bg-tertiary: #4A5568; /* Even Darker Slate */
                --color-text-base: #E2E8F0; /* Light Gray */
                --color-text-heading: #F7FAFC; /* White */
                --color-text-muted: #A0AEC0; /* Gray */
                --color-border-light: #4A5568; /* Dark Slate */
                --color-border-medium: #64748B; /* Medium Gray */
                --color-accent-primary: #F59E0B; /* Amber 500 (same) */
                --color-accent-secondary: #2EE6D6; /* Lighter Teal */
                --color-accent-tertiary: #0D7A70; /* Dark Teal */
                --color-accent-hover: #FBBF24; /* Amber 400 (same) */
                --color-button-primary-bg: #2EE6D6; /* Lighter Teal */
                --color-button-primary-hover-bg: #14B8A6; /* Teal 500 */
                --color-button-danger-bg: #EF4444; /* Red 500 (same) */
                --color-button-danger-hover-bg: #DC2626; /* Red 600 (same) */
                --color-button-neutral-bg: #64748B; /* Slate 500 (same) */
                --color-button-neutral-hover-bg: #475569; /* Slate 700 (same) */
                --color-input-border: #4A5568; /* Dark Slate */
                --color-input-focus-ring: #2EE6D6; /* Lighter Teal */
                --color-stat-primary: #2EE6D6; /* Lighter Teal */
                --color-stat-secondary: #E2E8F0; /* Light Gray */
                --color-error: #EF4444; /* Red 500 (same) */
                --color-success: #22C55E; /* Green 500 (same) */
                --color-info: #3B82F6; /* Blue 500 (same) */
            }
        }

        /* Custom utility classes using CSS variables */
        .bg-skin-primary { background-color: var(--color-bg-primary); }
        .bg-skin-secondary { background-color: var(--color-bg-secondary); }
        .bg-skin-tertiary { background-color: var(--color-bg-tertiary); }
        .text-skin-base { color: var(--color-text-base); }
        .text-skin-heading { color: var(--color-text-heading); }
        .text-skin-muted { color: var(--color-text-muted); }
        .border-skin-light { border-color: var(--color-border-light); }
        .border-skin-medium { border-color: var(--color-border-medium); }
        .text-accent-primary { color: var(--color-accent-primary); }
        .text-accent-secondary { color: var(--color-accent-secondary); }
        .bg-accent-tertiary { background-color: var(--color-accent-tertiary); }
        .hover-bg-accent-hover:hover { background-color: var(--color-accent-hover); }
        .bg-button-primary { background-color: var(--color-button-primary-bg); }
        .hover-bg-button-primary:hover { background-color: var(--color-button-primary-hover-bg); }
        .bg-button-danger { background-color: var(--color-button-danger-bg); }
        .hover-bg-button-danger:hover { background-color: var(--color-button-danger-hover-bg); }
        .bg-button-neutral { background-color: var(--color-button-neutral-bg); }
        .hover-bg-button-neutral:hover { background-color: var(--color-button-neutral-hover-bg); }
        .border-input { border-color: var(--color-input-border); }
        .focus-ring-input:focus {
            --tw-ring-color: var(--color-input-focus-ring);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
        }
        .text-stat-primary { color: var(--color-stat-primary); }
        .text-stat-secondary { color: var(--color-stat-secondary); }
        .text-error { color: var(--color-error); }
        .text-success { color: var(--color-success); }
        .text-info { color: var(--color-info); }


        body {
            background-color: var(--color-bg-primary);
            font-family: 'Inter', sans-serif;
            color: var(--color-text-base);
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap');
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .nav-item {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-item.active {
            border-bottom-color: var(--color-accent-primary);
            color: var(--color-text-heading);
        }
        .nav-item:hover {
            background-color: var(--color-bg-tertiary);
        }
        .system-slot {
            border: 2px dashed var(--color-border-light);
            min-height: 80px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .system-slot.core {
            border-style: solid;
            border-color: var(--color-border-medium);
        }
        .system-slot.filled {
            border-style: solid;
            border-color: var(--color-accent-secondary);
            background-color: var(--color-accent-tertiary);
        }
        .system-slot.filled:hover {
             background-color: var(--color-accent-hover);
        }
        .system-category-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .system-category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .draggable-system {
            cursor: grab;
            background-color: var(--color-bg-tertiary);
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: var(--color-text-heading);
            border: 1px solid var(--color-border-light);
        }
        .draggable-system:hover {
            background-color: var(--color-border-light);
        }
        .system-slot.drag-over {
            background-color: var(--color-accent-hover);
            border-color: var(--color-accent-primary);
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 320px; }
        }
        .filter-button {
            @apply px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-700 hover:bg-slate-200; /* Will be overridden by theme vars */
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-base);
        }
        .filter-button:hover {
            background-color: var(--color-border-light);
        }
        .filter-button.active {
            background-color: var(--color-accent-secondary);
            color: white;
        }
        .filter-button.active:hover {
            background-color: var(--color-button-primary-hover-bg);
        }

        /* Hamburger menu specific styles */
        .hamburger-menu-button {
            display: none; /* Hidden by default, shown on small screens */
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--color-text-heading);
            cursor: pointer;
            z-index: 50; /* Above other content */
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%; /* Adjust as needed */
            max-width: 300px;
            height: 100%;
            background-color: var(--color-bg-secondary);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40; /* Below backdrop */
            padding: 1.5rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .side-menu-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 30; /* Below side menu */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .side-menu-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments */
        @media (max-width: 1023px) { /* Equivalent to lg: hidden */
            .hamburger-menu-button {
                display: block;
            }
            .main-nav {
                display: none; /* Hide regular nav on small screens */
            }
        }
        @media (min-width: 1024px) { /* Equivalent to lg: block */
            .hamburger-menu-button {
                display: none;
            }
            .main-nav {
                display: flex; /* Show regular nav on large screens */
            }
            .side-menu, .side-menu-backdrop {
                display: none !important; /* Ensure hidden on large screens */
            }
        }

        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            text-align: center;
            max-width: 300px;
            color: var(--color-text-base);
        }
        .message-box button {
            margin-top: 15px;
            padding: 8px 16px;
            background-color: var(--color-button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased bg-skin-primary">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-6 flex items-center justify-between lg:justify-start">
            <button id="hamburger-btn" class="hamburger-menu-button mr-4">☰</button>
            <h1 class="text-4xl font-bold font-orbitron text-skin-heading">GURPS Interactive Shipyard</h1>
            <p class="text-skin-muted mt-1 hidden lg:block ml-4">Design and visualize your spacecraft based on the GURPS Spaceships rulebook.</p>
        </header>

        <nav class="flex border-b border-skin-light mb-6 main-nav">
            <div id="nav-shipyard" class="nav-item active">Shipyard Workbench</div>
            <div id="nav-rules" class="nav-item">Rules Reference</div>
            <div id="nav-examples" class="nav-item">Example Ships</div>
        </nav>

        <!-- Side Menu for Mobile -->
        <div id="side-menu" class="side-menu">
            <h2 class="text-2xl font-bold font-orbitron text-skin-heading mb-6">Navigation</h2>
            <nav class="flex flex-col space-y-4">
                <div id="side-nav-shipyard" class="nav-item active">Shipyard Workbench</div>
                <div id="side-nav-rules" class="nav-item">Rules Reference</div>
                <div id="side-nav-examples" class="nav-item">Example Ships</div>
            </nav>
        </div>
        <div id="side-menu-backdrop" class="side-menu-backdrop"></div>

        <!-- Main Content Views -->
        <main>
            <!-- Shipyard View -->
            <div id="view-shipyard">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column: Config & System Catalog -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <!-- Configuration -->
                        <div class="bg-skin-secondary p-4 rounded-lg shadow">
                            <h2 class="text-xl font-bold font-orbitron mb-3 text-skin-heading">1. Hull Configuration</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="hull-sm" class="block text-sm font-medium text-skin-base mb-1">Select Hull Size (SM)</label>
                                    <select id="hull-sm" class="w-full p-2 border border-input rounded-md focus:ring-2 focus-ring-input">
                                        <option value="SM+5">SM+5 (30 tons)</option>
                                        <option value="SM+6">SM+6 (100 tons)</option>
                                        <option value="SM+7">SM+7 (300 tons)</option>
                                        <option value="SM+8" selected>SM+8 (1,000 tons)</option>
                                        <option value="SM+9">SM+9 (3,000 tons)</option>
                                        <option value="SM+10">SM+10 (10,000 tons)</option>
                                        <option value="SM+11">SM+11 (30,000 tons)</option>
                                        <option value="SM+12">SM+12 (100,000 tons)</option>
                                        <option value="SM+13">SM+13 (300,000 tons)</option>
                                        <option value="SM+14">SM+14 (1,000,000 tons)</option>
                                        <option value="SM+15">SM+15 (3,000,000 tons)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tech-level" class="block text-sm font-medium text-skin-base mb-1">Select Tech Level (TL)</label>
                                    <select id="tech-level" class="w-full p-2 border border-input rounded-md focus:ring-2 focus-ring-input">
                                        <option value="7">TL7</option>
                                        <option value="8">TL8</option>
                                        <option value="9">TL9</option>
                                        <option value="10" selected>TL10</option>
                                        <option value="11">TL11</option>
                                        <option value="12">TL12</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-skin-base mb-1">Hull Type</label>
                                    <div class="flex gap-4">
                                       <label class="flex items-center"><input type="radio" name="hull-type" value="unstreamlined" class="form-radio h-4 w-4 text-accent-secondary" checked> <span class="ml-2">Unstreamlined</span></label>
                                       <label class="flex items-center"><input type="radio" name="hull-type" value="streamlined" class="form-radio h-4 w-4 text-accent-secondary"> <span class="ml-2">Streamlined</span></label>
                                    </div>
                                </div>
                                <div>
                                    <label class="flex items-center text-sm font-medium text-skin-base">
                                        <input type="checkbox" id="superscience-toggle" class="form-checkbox h-4 w-4 text-accent-secondary rounded">
                                        <span class="ml-2">Superscience Enabled (TL^)</span>
                                    </label>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <button id="export-ship-btn" class="w-full sm:w-1/3 bg-success text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-success">Export Ship</button>
                                    <button id="import-ship-btn" class="w-full sm:w-1/3 bg-info text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-info">Import Ship</button>
                                    <button id="clear-ship-btn" class="w-full sm:w-1/3 bg-button-danger text-white py-2 px-4 rounded-md hover-bg-button-danger focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-button-danger">Clear Ship</button>
                                </div>
                            </div>
                        </div>

                        <!-- System Catalog -->
                        <div class="bg-skin-secondary p-4 rounded-lg shadow flex-grow">
                            <h2 class="text-xl font-bold font-orbitron mb-3 text-skin-heading">2. System Catalog</h2>
                            <div class="flex flex-wrap gap-2 mb-4" id="category-filters">
                                <!-- Filter buttons will be injected here -->
                            </div>
                            <input type="text" id="system-search" placeholder="Search for systems..." class="w-full p-2 border border-input rounded-md mb-4">
                            <div id="system-catalog" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                <!-- Categories and systems will be injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Blueprint & Dashboard -->
                    <div class="lg:col-span-2 flex flex-col gap-6">
                        <!-- Blueprint -->
                        <div class="bg-skin-secondary p-4 rounded-lg shadow">
                            <h2 class="text-xl font-bold font-orbitron mb-3 text-skin-heading">3. Ship Blueprint</h2>
                             <p class="text-sm text-skin-muted mb-4">Your ship has <span id="slots-filled-count" class="font-bold">0</span> of 20 system slots filled. Drag systems from the catalog to the slots below.</p>
                            <div class="space-y-6">
                                <!-- Hull Sections will be injected here -->
                                <div id="blueprint-front"></div>
                                <div id="blueprint-central"></div>
                                <div id="blueprint-rear"></div>
                            </div>
                        </div>

                        <!-- Dashboard -->
                        <div class="bg-skin-secondary p-4 rounded-lg shadow">
                            <h2 class="text-xl font-bold font-orbitron mb-3 text-skin-heading">4. Live Dashboard</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">Total Cost</div>
                                    <div id="stat-cost" class="text-2xl stat-value text-stat-primary">$0</div>
                                </div>
                                <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">Power</div>
                                    <div id="stat-power" class="text-2xl stat-value text-stat-secondary">0 / 0</div>
                                </div>
                                <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">dDR (F/C/R)</div>
                                    <div id="stat-ddr" class="text-2xl stat-value text-stat-secondary">0/0/0</div>
                                </div>
                                <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">Acceleration</div>
                                    <div id="stat-accel" class="text-2xl stat-value text-stat-secondary">0 G</div>
                                </div>
                                <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">Delta-V</div>
                                    <div id="stat-deltav" class="text-2xl stat-value text-stat-secondary">0 mps</div>
                                </div>
                                 <div class="bg-skin-tertiary p-3 rounded-lg">
                                    <div class="text-sm text-skin-muted">FTL Rating</div>
                                    <div id="stat-ftl" class="text-2xl stat-value text-stat-secondary">0x</div>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-skin-base text-center mb-2">Cost Breakdown</h3>
                                    <div class="chart-container"><canvas id="cost-chart"></canvas></div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-skin-base text-center mb-2">Performance Profile</h3>
                                    <div class="chart-container"><canvas id="performance-chart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rules View -->
            <div id="view-rules" class="hidden bg-skin-secondary p-6 rounded-lg shadow">
                 <h2 class="text-2xl font-bold font-orbitron mb-4 text-skin-heading">Core Rules Reference</h2>
                 <p class="mb-6 text-skin-base">A quick reference for key mechanics from the GURPS Spaceships report. This section helps contextualize your design choices and understand their in-game implications for travel and combat.</p>
                 <div class="space-y-4" id="rules-content">
                    <!-- Rules content will be injected by JS -->
                 </div>
            </div>

            <!-- Examples View -->
            <div id="view-examples" class="hidden bg-skin-secondary p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold font-orbitron mb-4 text-skin-heading">Example Spacecraft</h2>
                <p class="mb-6 text-skin-base">These are example ships from the GURPS Spaceships report, demonstrating how different systems combine to create a complete vessel. Use them as inspiration for your own designs.</p>
                <div class="space-y-8" id="examples-content">
                    <!-- Example ships will be injected by JS -->
                </div>
            </div>

        </main>
    </div>

    <!-- System Details Modal -->
    <div id="system-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-skin-secondary rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-start">
                <h2 id="modal-title" class="text-2xl font-bold font-orbitron text-skin-heading">System Details</h2>
                <button id="modal-close" class="text-skin-muted hover:text-skin-heading">&times;</button>
            </div>
            <hr class="my-3 border-skin-light">
            <div id="modal-body" class="text-skin-base space-y-2"></div>
            <div class="mt-4 text-right">
                <button id="modal-add-system" class="px-4 py-2 bg-button-primary text-white rounded-md hover-bg-button-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-secondary">Add to Ship</button>
            </div>
        </div>
    </div>

    <!-- Export Ship Modal -->
    <div id="export-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-skin-secondary rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold font-orbitron text-skin-heading">Export Ship Design</h2>
                <button id="export-modal-close" class="text-skin-muted hover:text-skin-heading">&times;</button>
            </div>
            <hr class="my-3 border-skin-light">
            <p class="text-skin-base mb-4">Copy the JSON below to save your ship design. You can paste it back later using the "Import Ship" button.</p>
            <textarea id="export-json-textarea" class="w-full h-64 p-3 border border-input rounded-md font-mono text-sm bg-skin-primary text-skin-base" readonly></textarea>
            <div class="mt-4 text-right">
                <button id="copy-json-btn" class="px-4 py-2 bg-button-primary text-white rounded-md hover-bg-button-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-secondary">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Import Ship Modal -->
    <div id="import-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-skin-secondary rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold font-orbitron text-skin-heading">Import Ship Design</h2>
                <button id="import-modal-close" class="text-skin-muted hover:text-skin-heading">&times;</button>
            </div>
            <hr class="my-3 border-skin-light">
            <p class="text-skin-base mb-4">Paste your ship design JSON below and click "Import" to load it.</p>
            <textarea id="import-json-textarea" class="w-full h-64 p-3 border border-input rounded-md font-mono text-sm bg-skin-primary text-skin-base"></textarea>
            <div class="mt-4 text-right">
                <button id="perform-import-btn" class="px-4 py-2 bg-info text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-info">Import</button>
            </div>
        </div>
    </div>

    <!-- Confirm Clear Modal -->
    <div id="confirm-clear-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-skin-secondary rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold font-orbitron mb-3 text-skin-heading">Unsaved Changes</h2>
            <p class="text-skin-base mb-4">You have unsaved changes. Do you want to save them before clearing the ship?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-clear-save-btn" class="px-4 py-2 bg-success text-white rounded-md hover:bg-green-700">Save & Clear</button>
                <button id="confirm-clear-discard-btn" class="px-4 py-2 bg-button-danger text-white rounded-md hover-bg-button-danger">Discard & Clear</button>
                <button id="confirm-clear-cancel-btn" class="px-4 py-2 bg-button-neutral text-white rounded-md hover-bg-button-neutral">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="message-box">
        <p id="message-box-text"></p>
        <button onclick="document.getElementById('message-box').style.display='none';">OK</button>
    </div>
    
    <script>
        // Helper to map SM string to array index (SM+5 -> 0, SM+15 -> 10)
        function smToIndex(sm) {
            return parseInt(sm.substring(3)) - 5;
        }

        // Helper to map array index to SM string
        function indexToSm(index) {
            return `SM+${index + 5}`;
        }

        // Function to convert an array of SM values back to a dictionary (for export)
        function convertSmArrayToDict(smArray) {
            if (!smArray || !Array.isArray(smArray)) {
                return smArray; // Not an array to convert
            }
            const dict = {};
            for (let i = 0; i < smArray.length; i++) {
                if (smArray[i] !== null && smArray[i] !== undefined) {
                    dict[indexToSm(i)] = smArray[i];
                }
            }
            return dict;
        }

        // List of properties within system data that are SM-dependent and should be converted to/from arrays
        const SM_DEPENDENT_PROPERTIES = [
            'cost', 'us_dDR', 'sl_dDR', 'capacity', 'fuel_tons', 'launch_rate',
            'complexity', 'comm_sensor_level', 'control_stations', 'array_level',
            'production_per_hr', 'lbs_per_hr', 'dDR', 'max_tonnage', 'tons_per_hr',
            'beam_output', 'gun_caliber', 'launchers', 'missile_shots', 'gun_shots'
        ];

        // Data Module: All data from the GURPS Spaceships PDF is structured here.
        // SM-dependent values are now arrays (index 0 = SM+5, index 10 = SM+15)
        const shipData = {
            hulls: {
                "SM+5": { mass: 30, dSTHP: 20, hndSr: "0/4" },
                "SM+6": { mass: 100, dSTHP: 30, hndSr: "0/4" },
                "SM+7": { mass: 300, dSTHP: 50, hndSr: "-1/5" },
                "SM+8": { mass: 1000, dSTHP: 70, hndSr: "-1/5" },
                "SM+9": { mass: 3000, dSTHP: 100, hndSr: "-1/5" },
                "SM+10": { mass: 10000, dSTHP: 150, hndSr: "-2/5" },
                "SM+11": { mass: 30000, dSTHP: 200, hndSr: "-2/5" },
                "SM+12": { mass: 100000, dSTHP: 300, hndSr: "-2/5" },
                "SM+13": { mass: 300000, dSTHP: 500, hndSr: "-3/5" },
                "SM+14": { mass: 1000000, dSTHP: 700, hndSr: "-3/5" },
                "SM+15": { mass: 3000000, dSTHP: 1000, hndSr: "-3/5" },
            },
            systems: {
                "Armor": {
                    "Armor, Ice (TL0)": {
                        location: 'hull',
                        cost: [null, null, null, '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K'],
                        us_dDR: [null, null, null, 1, 2, 2, 3, 5, 7, 10, 15],
                        sl_dDR: [null, null, null, null, null, null, null, null, null, null, null], // Not available for streamlined
                        desc: "Armor made from frozen water. Semi-ablative. Not available for SM+5 to SM+7 hulls, nor for streamlined hulls."
                    },
                    "Armor, Stone (TL0)": {
                        location: 'hull',
                        cost: [null, null, '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K', '0.001K'],
                        us_dDR: [null, null, 1, 2, 2, 3, 5, 7, 10, 15, 20],
                        sl_dDR: [null, null, null, null, null, null, null, null, null, null, null], // Not available for streamlined
                        desc: "Rock armor for vessels that are hollowed-out asteroids, or covered with a layer of rock or slag. Semi-ablative. Unavailable for SM+5-6 hulls, or for streamlined hulls."
                    },
                    "Armor, Steel (TL7)": {
                        location: 'hull',
                        cost: ['6K', '20K', '60K', '200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M'],
                        us_dDR: [1, 2, 3, 5, 7, 10, 15, 20, 30, 50, 70],
                        sl_dDR: [1, 1, 2, 3, 5, 7, 10, 15, 20, 30, 50],
                        desc: "High-quality steel plate armor. Common due to its low cost."
                    },
                    "Armor, Light Alloy (TL7)": {
                        location: 'hull',
                        cost: ['15K', '50K', '150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B'],
                        us_dDR: [2, 3, 5, 7, 10, 15, 20, 30, 50, 70, 100],
                        sl_dDR: [1, 2, 3, 5, 7, 10, 15, 20, 30, 50, 70],
                        desc: "Armor made of aerospace-grade aluminum or titanium alloys."
                    },
                    "Armor, Metallic Laminate (TL8)": {
                        location: 'hull',
                        cost: ['30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'],
                        us_dDR: [3, 5, 7, 10, 15, 20, 30, 50, 70, 100, 150],
                        sl_dDR: [2, 3, 5, 7, 10, 15, 20, 30, 50, 70, 100],
                        desc: "Titanium, aluminum, beryllium, or ultra-hard steel alloy reinforced with carbon fibers, ceramic fibers, or intermetallic laminates."
                    },
                    "Armor, Advanced Metallic Laminate (TL9)": {
                        location: 'hull',
                        cost: ['60K', '200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B'],
                        us_dDR: [5, 7, 10, 15, 20, 30, 50, 70, 100, 150, 200],
                        sl_dDR: [3, 5, 7, 10, 15, 20, 30, 50, 70, 100, 150],
                        desc: "Armor similar to metallic laminate, but reinforced with super-strong carbon nanotubes, boron nanotubes, or diamond whiskers."
                    },
                    "Armor, Nanocomposite (TL10)": {
                        location: 'hull',
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        us_dDR: [7, 10, 15, 20, 30, 50, 70, 100, 150, 200, 300],
                        sl_dDR: [5, 7, 10, 15, 20, 30, 50, 70, 100, 150, 200],
                        desc: "Armor uses ultra-strength carbon or boron nanotube-reinforced polymers. Can also represent biotech hulls."
                    },
                    "Armor, Organic (TL10)": {
                        location: 'hull',
                        cost: ['10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B'],
                        us_dDR: [2, 3, 5, 7, 10, 15, 20, 30, 50, 70, 100],
                        sl_dDR: [1, 2, 3, 5, 7, 10, 11, 12, 13, 14, 15], // Corrected to be 11, 12, 13, 14, 15 for SM+10 to SM+15
                        desc: "Low-cost armor made of advanced biotech materials (space-adapted wood or living tissue, living bioplastic, etc.). DR is halved against burning or corrosion damage."
                    },
                    "Armor, Diamondoid (TL11)": {
                        location: 'hull',
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        us_dDR: [10, 15, 20, 30, 50, 70, 100, 150, 200, 300, 500],
                        sl_dDR: [7, 10, 15, 20, 30, 50, 70, 100, 150, 200, 300],
                        desc: "Armor system uses super-hard nano-fabricated materials such as diamondoid, ultra-hard fullerites, or cubic boron nitride."
                    },
                    "Armor, Exotic Laminate (TL12)": {
                        location: 'hull',
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'],
                        us_dDR: [15, 20, 30, 50, 70, 100, 150, 200, 300, 500, 700],
                        sl_dDR: [10, 15, 20, 30, 50, 70, 100, 150, 200, 300, 500],
                        desc: "Tougher armor than diamondoid, usually a complex laminate of ultra-hard materials and high-density exotic matter."
                    },
                },
                "Cargo & Storage": {
                    "Cargo Hold (TL7)": {
                        location: 'any',
                        cost: 0,
                        capacity: [1.5, 5, 15, 50, 150, 500, 1500, 5000, 15000, 50000, 150000],
                        desc: "Ordinary cargo space. Cost is negligible."
                    },
                    "Fuel Tank (TL7)": {
                        location: 'any',
                        cost: ['10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '3B'],
                        fuel_tons: [1.5, 5, 15, 50, 150, 500, 1500, 5000, 15000, 50000, 150000],
                        desc: "A full tank of reaction mass for a reaction drive."
                    },
                    "Hangar Bay (TL7)": {
                        location: 'hull',
                        cost: ['3K', '10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M'],
                        capacity: [1, 3, 10, 30, 100, 300, 1000, 3000, 10000, 30000, 100000],
                        launch_rate: [1, 3, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000],
                        desc: "A bay capable of storing, launching, and retrieving other vehicles (spacecraft, trucks, etc.)."
                    },
                },
                "Control & Sensors": {
                    "Cloaking Device (TL^)": {
                        location: 'any',
                        isHighEnergy: true,
                        cost: ['1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B', '100B'],
                        desc: "A superscience, energy-intensive stealth system that makes the vessel invisible to vision and to active and passive imaging sensors. -10 to be detected by sensors."
                    },
                    "Contragravity Lifter (TL^)": {
                        location: 'any',
                        isHighEnergy: true,
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Selectively nullifies some or all of the pull of gravity on the spacecraft, but does not actually provide any acceleration. Can cancel up to 10G."
                    },
                    "Control Room (TL7)": {
                        location: 'any',
                        cost: ['60K', '200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B'],
                        complexity: [6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11], // Base complexity
                        comm_sensor_level: [-6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4], // TL-relative
                        control_stations: [1, 2, 3, 4, 6, 10, 15, 20, 30, 40, 60],
                        desc: "All spacecraft capable of maneuvering require a control room. Includes basic comm/sensor array and attitude thrusters/gyros."
                    },
                    "Defensive ECM (TL7)": {
                        location: 'any',
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Array of automatic self-defense jamming antenna, decoy systems, etc. that protects the spacecraft from being hit by enemy fire. Gives a -2 to ranged attacks against the vessel. Max 3 can be installed."
                    },
                    "Enhanced Array (TL7)": {
                        location: 'hull',
                        cost: ['60K', '200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B'],
                        array_level: [-4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6], // TL-relative
                        desc: "A larger and more capable version of the basic array that comes with a control room system."
                    },
                    "Science Array (TL7)": {
                        location: 'hull',
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'], // 5x Enhanced cost
                        array_level: [-4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6], // TL-relative
                        desc: "Incorporates highly sensitive instruments for astronomical and physics surveys, as well as an enhanced array."
                    },
                    "Tactical Array (TL7)": {
                        location: 'hull',
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'], // 5x Enhanced cost
                        array_level: [-4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6], // TL-relative
                        desc: "Has the same capabilities as an enhanced array, but adds the ability to actively jam transmissions and overcome defensive ECM."
                    },
                    "Multipurpose Array (TL7)": {
                        location: 'hull',
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 10x Enhanced cost
                        array_level: [-4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6], // TL-relative
                        desc: "Combines science and tactical array functions."
                    },
                },
                "Propulsion": {
                    "Jet Engine (TL7)": {
                        location: 'rear',
                        accel: 1,
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Functions only in an atmosphere containing oxygen. Provides 1G acceleration for atmospheric speed. Consumes one fuel tank worth of jet fuel per half-hour (TL7) or hour (TL8+)."
                    },
                    "Reaction Engine, Chemical Rocket (TL7)": {
                        location: 'rear',
                        accel: 3,
                        deltaV_per_tank: 0.15,
                        cost: ['60K', '200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B'],
                        desc: "Burns fuel and oxidizer to produce thrust. Each engine provides 3G acceleration. Each fuel tank provides 0.15 mps delta-V."
                    },
                    "Reaction Engine, HEDM Chemical Rocket (TL9)": {
                        location: 'rear',
                        accel: 2,
                        deltaV_per_tank: 0.5,
                        cost: ['90K', '300K', '900K', '3M', '9M', '30M', '90M', '300M', '900M', '3B', '9B'], // 1.5x Chemical Rocket
                        desc: "Uses high-energy density materials for fuel. Each engine gives 2G acceleration. Each fuel tank provides 0.5 mps delta-V, but may explode if damaged."
                    },
                    "Reaction Engine, Ion Drive (TL8)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: 0.0005,
                        deltaV_per_tank: 3,
                        cost: ['100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B'],
                        desc: "High-impulse, low-thrust engine. Requires electrical power and reaction mass. Each engine provides 0.0005G acceleration. Each fuel tank provides 3 mps delta-V."
                    },
                    "Reaction Engine, Mass Driver (TL9)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: 0.01,
                        deltaV_per_tank: 0.3,
                        cost: ['100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B'],
                        desc: "Electromagnetic accelerator that launches buckets of reaction mass. Can use just about anything as reaction mass. Each fuel tank or cargo hold provides 0.3 mps delta-V. Each engine provides 0.01G acceleration."
                    },
                    "Reaction Engine, Nuclear Thermal Rocket (NTR) (TL7)": {
                        location: 'rear',
                        accel: { "TL7": 0.1, "TL8": 0.2, "TL9": 0.5, "TL10": 0.5, "TL11": 0.5, "TL12": 0.5 },
                        deltaV_per_tank: { "TL7": 0.3, "TL8": 0.3, "TL9": 0.45, "TL10": 0.45, "TL11": 0.45, "TL12": 0.45 },
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        desc: "Heats a fluid as it passes through a built-in solid- or liquid-core nuclear reactor. Accel and Delta-V are TL-dependent."
                    },
                    "Reaction Engine, Nuclear Light Bulb (TL9)": {
                        location: 'rear',
                        accel: { "TL9": 0.01, "TL10": 0.05, "TL11": 0.05, "TL12": 0.05 },
                        deltaV_per_tank: 0.8,
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        desc: "Enclosed gas-core fission drive. Accel is TL-dependent. Each fuel tank provides 0.8 mps delta-V."
                    },
                    "Reaction Engine, Nuclear Saltwater Rocket (TL9^)": {
                        location: 'rear',
                        accel: 2,
                        deltaV_per_tank: 2.5,
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        desc: "High-performance 'fission torch' rocket fuelled by water containing dissolved salts of enriched uranium. Engine and fuel may explode if damaged."
                    },
                    "Reaction Engine, External Pulsed Plasma ('Orion Drive') (TL7)": {
                        location: 'rear',
                        accel: 2,
                        deltaV_per_tank: { "TL7": 2, "TL8": 3, "TL9": 4, "TL10": 8, "TL11": 8, "TL12": 8 },
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Uses pulse units (shaped nuclear bombs) to generate thrust. Rear hull section must have dDR 50+ or dDR 5+ with magnetic sail. Delta-V is TL-dependent."
                    },
                    "Reaction Engine, Fusion Pulse Drive (TL9)": {
                        location: 'rear',
                        accel: { "TL9": 0.01, "TL10": 0.05, "TL11": 0.05, "TL12": 0.05 },
                        deltaV_per_tank: { "TL9": 5, "TL10": 10, "TL11": 40, "TL12": 40 },
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Uses laser/particle beams and/or miniscule amounts of antimatter to trigger fusion micro-explosions. Accel and Delta-V are TL-dependent."
                    },
                    "Reaction Engine, Advanced Fusion Pulse Drive (TL9)": {
                        location: 'rear',
                        accel: 0.005,
                        deltaV_per_tank: { "TL9": 20, "TL10": 100, "TL11": 350, "TL12": 350 },
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 2x base cost
                        desc: "Fusion pulse drive optimized for outer system or interstellar travel. Delta-V is TL-dependent."
                    },
                    "Reaction Engine, Super Fusion Pulse Drive (TL11^)": {
                        location: 'rear',
                        accel: { "TL11": 20, "TL12": 100 },
                        deltaV_per_tank: 350,
                        cost: ['1.2M', '4M', '12M', '40M', '120M', '400M', '1.2B', '4B', '12B', '40B', '120B'], // 4x base cost
                        desc: "Uses extensive superscience (e.g., force field pusher plates and inertial dampers). Accel is TL-dependent. Each tank provides 350 MPS delta-V."
                    },
                    "Reaction Engine, Fusion Rocket (TL9)": {
                        location: 'rear',
                        accel: 0.005,
                        deltaV_per_tank: { "TL9": 12, "TL10": 60, "TL11": 180, "TL12": 450 },
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Generates a fusion reaction to heat hydrogen into plasma. Delta-V is TL-dependent. Requires minimum SM+9 at TL9."
                    },
                    "Reaction Engine, Fusion Torch (TL10^)": {
                        location: 'rear',
                        accel: { "TL10": 0.5, "TL11": 1, "TL12": 1 },
                        deltaV_per_tank: { "TL10": 15, "TL11": 45, "TL12": 150 },
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 2x Fusion Rocket
                        desc: "Limited superscience high-performance fusion rocket. Accel and Delta-V are TL-dependent."
                    },
                    "Reaction Engine, Super Fusion Torch (TL11^)": {
                        location: 'rear',
                        accel: 50,
                        deltaV_per_tank: 450,
                        cost: ['1.2M', '4M', '12M', '40M', '120M', '400M', '1.2B', '4B', '12B', '40B', '120B'], // 4x Fusion Rocket
                        desc: "Fusion drive derivative of the cosmic super fusion reactor. Provides 50G acceleration. Each fuel tank provides 450 mps delta-V."
                    },
                    "Reaction Engine, Antimatter Thermal Rocket (TL9)": {
                        location: 'rear',
                        accel: { "TL9": 0.1, "TL10": 0.2, "TL11": 0.4, "TL12": 0.4 },
                        deltaV_per_tank: 1.8,
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        desc: "Annihilation of tiny amount of antimatter directly heats reaction mass. Accel is TL-dependent. Each fuel tank provides 1.8 mps delta-V."
                    },
                    "Reaction Engine, Antimatter Plasma Rocket (TL10)": {
                        location: 'rear',
                        accel: 0.01,
                        deltaV_per_tank: { "TL10": 120, "TL11": 360, "TL12": 360 },
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        desc: "Uses antimatter to heat reaction mass into hot plasma. Delta-V is TL-dependent."
                    },
                    "Reaction Engine, Antimatter Plasma Torch (TL10^)": {
                        location: 'rear',
                        accel: 1,
                        deltaV_per_tank: { "TL10": 120, "TL11": 360, "TL12": 360 },
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'], // 2x Plasma Rocket
                        desc: "High-performance limited superscience version of the antimatter plasma rocket. Delta-V is TL-dependent."
                    },
                    "Reaction Engine, Super Antimatter Plasma Torch (TL11^)": {
                        location: 'rear',
                        accel: 100,
                        deltaV_per_tank: 360,
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 4x Plasma Rocket
                        desc: "Uses superscience technologies to boost performance. Provides 100G acceleration. Each fuel tank provides 360 mps delta-V."
                    },
                    "Reaction Engine, Antimatter Pion (TL11)": {
                        location: 'rear',
                        accel: 0.005,
                        deltaV_per_tank: 3400,
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'], // 2x base cost of Antimatter Thermal
                        desc: "Matter and antimatter are annihilated at a 1:1 ratio. Each engine gives 0.005G acceleration. Each fuel tank provides 3,400 mps of delta-V."
                    },
                    "Reaction Engine, Antimatter Pion Torch (TL11^)": {
                        location: 'rear',
                        accel: 0.1,
                        deltaV_per_tank: 3400,
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 4x base cost of Antimatter Thermal
                        desc: "Superscience version of Antimatter Pion. Each engine gives 0.1G acceleration. Each fuel tank provides 3,400 mps of delta-V."
                    },
                    "Reaction Engine, Total Conversion Torch (TL12^)": {
                        location: 'rear',
                        accel: 1,
                        deltaV_per_tank: 10000,
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'], // 4x base cost of Antimatter Thermal
                        desc: "Converts matter directly into energy with 100% efficiency. Each engine gives 1G acceleration. Each fuel tank provides 10,000 mps delta-V."
                    },
                    "Reaction Engine, Super Conversion Torch (TL12^)": {
                        location: 'rear',
                        accel: 50,
                        deltaV_per_tank: 10000,
                        cost: ['1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B', '150B'], // 10x base cost of Antimatter Thermal
                        desc: "Engine derived from the cosmic super fusion reactor. Provides 50G acceleration. Each fuel tank provides 10,000 mps delta-V."
                    },
                    "Reactionless Engine, Rotary (TL7^)": {
                        location: 'rear', // Can also be central
                        isHighEnergy: true,
                        accel: 0.1,
                        cost: ['15K', '50K', '150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B'],
                        desc: "Uses oscillating rotating masses. Each engine gives 0.1G acceleration. Top speed near-lightspeed."
                    },
                    "Reactionless Engine, Standard (TL10^)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: { "TL10": 0.5, "TL11": 1, "TL12": 1 },
                        cost: ['30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'],
                        desc: "Each engine gives 0.5G acceleration at TL10 or 1G at TL11-12. Top speed near-lightspeed."
                    },
                    "Reactionless Engine, Hot (TL10^)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: { "TL10": 1, "TL11": 2, "TL12": 2 },
                        cost: ['100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B'],
                        desc: "Each engine gives 1G acceleration at TL10 or 2G at TL11-12. Has a waste-heat signature."
                    },
                    "Reactionless Engine, Super (TL11^)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: { "TL11": 50, "TL12": 100 },
                        cost: ['200K', '600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B'],
                        desc: "Provides 50G acceleration at TL11 or 100G at TL12. Top speed near-lightspeed."
                    },
                    "Reactionless Engine, Subwarp (TL^)": {
                        location: 'rear',
                        isHighEnergy: true,
                        accel: 500,
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Each engine gives 500G acceleration. Usually a pseudo-velocity drive."
                    },
                    "Space Sail, Lightsail (TL9)": {
                        location: 'hull',
                        accel: 0.0001, // Per G at 1 AU
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', null, null, null], // SM+13+ not available
                        desc: "Generates thrust from starlight or launching lasers. Typical thrust 0.0001G per system at 1 AU. Exposed system."
                    },
                    "Space Sail, Magsail (TL9)": {
                        location: 'hull',
                        isHighEnergy: true,
                        accel: 0.001, // Per G
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', null, null, null], // SM+13+ not available
                        desc: "Huge superconducting loop interacting with solar wind. Typical thrust 0.001G per system. Top speed cannot exceed 375 mps. Exposed system. Requires 1 Power Point."
                    },
                    "Stardrive Engine (TL^)": {
                        location: 'any',
                        isHighEnergy: true,
                        ftl: 1,
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "A faster-than-light drive (hyperdrive, jump drive, or warp drive). Provides FTL-1 rating. Requires 1 Power Point."
                    },
                    "Super Stardrive Engine (TL^)": {
                        location: 'any',
                        isHighEnergy: true,
                        ftl: { "TL11": 1, "TL12": 2 }, // Can provide FTL-1 or FTL-2 with 2 Power Points
                        cost: ['1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B', '150B'], // 5x base stardrive
                        desc: "More powerful stardrive. Can provide FTL-1 (1 PP) or FTL-2 (2 PP). Requires 1 or 2 Power Points."
                    },
                },
                "Power": {
                    "Power Plant, Chemical Energy (Fuel Cell) (TL7)": {
                        location: 'any',
                        power: 1,
                        endurance_hours: { "TL7": 3, "TL8": 6, "TL9": 12, "TL10": 24, "TL11": 24, "TL12": 24 },
                        cost: ['15K', '50K', '150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B'],
                        desc: "High-efficiency chemical energy closed-cycle power plant. Provides 1 Power Point. Endurance is TL-dependent."
                    },
                    "Power Plant, Chemical Energy (MHD Turbine) (TL9)": {
                        location: 'any',
                        power: 2,
                        endurance_hours: { "TL9": 6, "TL10": 12, "TL11": 12, "TL12": 12 },
                        cost: ['30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'], // 2x Fuel Cell
                        desc: "Advanced high-performance closed-cycle turbine. Provides 2 Power Points. Endurance is TL-dependent."
                    },
                    "Power Plant, Fission Reactor (TL8)": {
                        location: 'any',
                        power: 1,
                        endurance_years: { "TL8": 25, "TL9": 50, "TL10": 75, "TL11": 75, "TL12": 75 },
                        cost: ['100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B'],
                        desc: "High-performance nuclear fission reactor. Provides 1 Power Point. Endurance is TL-dependent."
                    },
                    "Power Plant, Fusion Reactor (TL9)": {
                        location: 'any',
                        power: 2,
                        endurance_years: { "TL9": 50, "TL10": 200, "TL11": 600, "TL12": 1500 },
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Uses a thermonuclear fusion reaction. Provides 2 Power Points. Endurance is TL-dependent. Requires minimum SM+10 at TL9."
                    },
                    "Power Plant, Antimatter (TL10)": {
                        location: 'any',
                        power: 4,
                        endurance_years: { "TL10": 2, "TL11": 20, "TL12": 200 },
                        cost: ['600K', '2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B'],
                        desc: "Uses a matter-antimatter reaction. Provides 4 Power Points. Endurance is TL-dependent. May explode if damaged."
                    },
                    "Power Plant, Super Fusion (TL11)": {
                        location: 'any',
                        power: 4,
                        endurance_years: { "TL11": 400, "TL12": 1000 },
                        cost: ['1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B', '100B'],
                        desc: "Exotic fusion system (muon-catalyzed or black hole catalyzed). Provides 4 Power Points. Endurance is TL-dependent."
                    },
                    "Power Plant, Total Conversion (TL12^)": {
                        location: 'any',
                        power: 5,
                        endurance_years: "unlimited",
                        cost: ['2M', '6M', '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B', '200B'],
                        desc: "Converts matter directly into energy with 100% efficiency. Provides 5 Power Points with effectively unlimited endurance."
                    },
                },
                "Habitation & Life Support": {
                    "Habitat (TL7)": {
                        location: 'any',
                        cost: [null, '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'],
                        num_cabins: [null, 1, 2, 6, 20, 60, 200, 600, 2000, 6000, 20000],
                        desc: "Provides living quarters and extended life support for spacecraft crew during long voyages. Not available on SM+5 craft."
                    },
                    "Passenger Seating (TL7)": {
                        location: 'any',
                        cost: ['10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B'],
                        num_seats: [2, 6, 20, 60, 200, 600, 2000, 6000, 20000, 60000, 200000],
                        desc: "Airliner-style passenger seats for short voyages. Includes 24 hours of limited life support per seat."
                    },
                    "Open Space (TL7)": {
                        location: 'any',
                        cost: [null, null, null, '100K', '200K', '500K', '1M', '2M', '5M', '10M', '20M'],
                        num_areas: [null, null, null, 1, 2, 5, 10, 20, 50, 100, 200],
                        desc: "Pressurized hall or other large, open space (auditorium, farm, garden, pool, theater, zoo). Can provide food if used as gardens/farms."
                    },
                },
                "Special Systems": {
                    "Engine Room (TL7)": {
                        location: 'any',
                        cost: ['15K', '30K', '100K', '300K', '1M', null, null, null, null, null, null], // SM+10+ don't require it
                        desc: "Includes room, tools, and parts sufficient to maintain and repair the craft. Comes with one control station. Not required on SM+10+ craft."
                    },
                    "External Clamp (TL7)": {
                        location: 'hull',
                        cost: ['3K', '10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M'],
                        desc: "System of clamps or grapples to attach to another spacecraft or object. Can tow or push."
                    },
                    "Factory (Fabricator) (TL8)": {
                        location: 'any',
                        isHighEnergy: true,
                        production_per_hr: [null, '5K', '15K', '50K', '150K', '500K', '1.5M', '5M', '15M', 150000, 500000],
                        cost: [null, '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B', '150B'],
                        desc: "Industrial system capable of fabricating spare parts or other goods. Requires component parts (40% of value). Unavailable for SM+5 craft."
                    },
                    "Factory (Robofac) (TL10)": {
                        location: 'any',
                        isHighEnergy: true,
                        production_per_hr: [null, '10K', '30K', '100K', '300K', '1M', '3M', '10M', '30M', 300000, 1000000], // 2x Fabricator
                        cost: [null, '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B', '100B', '300B'], // 2x Fabricator
                        desc: "As Fabricator, but faster and capable of self-operation with its own Machinist-14 skill."
                    },
                    "Factory (Nanofactory) (TL11)": {
                        location: 'any',
                        isHighEnergy: true,
                        production_per_hr: [null, '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', 3000000, 10000000], // 20x Fabricator
                        cost: [null, '20M', '60M', '200M', '600M', '2B', '6B', '20B', '60B', '200B', '600B'], // 4x Fabricator
                        desc: "A 'cornucopia' capable of manufacturing goods from raw materials (carbon, metals, etc.)."
                    },
                    "Factory (Replicator) (TL12^)": {
                        location: 'any',
                        isHighEnergy: true,
                        lbs_per_hr: [null, 0.5, 1.5, 5, 15, 50, 150, 500, 1500, 5000, 15000],
                        cost: [null, '100M', '300M', '1B', '3B', '10B', '30B', '100B', '300B', '1T', '3T'], // 20x Fabricator
                        desc: "A nuclear synthesis machine capable of transforming one element into another, and creating goods from transmutation of bulk matter."
                    },
                    "Force Screen (Light) (TL11^)": {
                        location: 'any',
                        isHighEnergy: true,
                        dDR: [20, 30, 50, 75, 100, 150, 250, 350, 500, 750, 1000],
                        cost: ['500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B'],
                        desc: "Generates a protective force field around the entire vessel. Regenerates 10% of lost dDR every second. Subtract force screen dDR first, then any armor dDR."
                    },
                    "Force Screen (Heavy) (TL11^)": {
                        location: 'any',
                        isHighEnergy: true,
                        dDR: [40, 60, 100, 150, 200, 300, 500, 700, 1000, 1500, 2000], // Doubles dDR of light screen
                        cost: ['1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B', '150B'], // 3x Light screen cost
                        desc: "High-power screen. Can double its dDR by using a second Power Point. Regenerates 10% of lost dDR every second."
                    },
                    "Jump Gate (TL^)": {
                        location: 'hull',
                        isHighEnergy: true,
                        cost: [null, null, null, null, '150M', '500M', '1.5B', '5B', '50B', '150B', '500B'],
                        max_tonnage: [null, null, null, null, 100, 300, 1000, 3000, 10000, 30000, 100000],
                        desc: "One side of an artificial wormhole portal that connects to another distant jump gate, usually permitting instant FTL transit. Requires 1 Power Point."
                    },
                    "Mining (TL7)": {
                        location: 'any',
                        isHighEnergy: true,
                        tons_per_hr: [0.15, 0.5, 1.5, 5, 15, 50, 150, 500, 1500, 5000, 15000],
                        cost: ['30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'],
                        desc: "Heavy-duty mining and processing system that can extract ore from rock. Requires 1 Power Point."
                    },
                    "Chemical Refinery (TL7)": {
                        location: 'any',
                        isHighEnergy: true,
                        tons_per_hr: [0.5, 1.5, 5, 15, 50, 150, 500, 1500, 5000, 15000, 50000],
                        cost: ['30K', '100K', '300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B'],
                        desc: "Processes ice or water into hydrogen and oxygen for rocket fuel or reaction mass. Requires 1 Power Point."
                    },
                    "Ramscoop (TL10)": {
                        location: 'front',
                        isHighEnergy: true,
                        cost: ['3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B', '100B', '300B'],
                        desc: "Electromagnetic scoop to capture interstellar hydrogen molecules for fuel and reaction mass. Provides unlimited reaction mass for one drive system at 1,800 mps or more. Requires 1 Power Point."
                    },
                    "Robot Arm (TL8)": {
                        location: 'hull',
                        cost: ['300K', '1M', '3M', '10M', '30M', '100M', '300M', '1B', '3B', '10B', '30B'],
                        desc: "Hand- or gripper-equipped arm, proportionately sized to the spacecraft, that can grab and manipulate objects. Can also function as an external clamp."
                    },
                    "Soft-Landing System (TL7)": {
                        location: 'hull',
                        cost: ['50K', '100K', '200K', '500K', '1M', '2M', '5M', '10M', '20M', '50M', '100M'],
                        desc: "Reentry shield, airbags, or parachutes designed to allow a vessel that lacks wings, thrust, or contragravity to safely land from low orbit. Destroyed after use."
                    },
                    "Solar Panel Array (TL7)": {
                        location: 'hull',
                        cost: ['150K', '500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B'],
                        power: 1,
                        desc: "Solar power system. Generates one Power Point if exposed to sunlight. Exposed system, not protected by armor."
                    },
                    "Stasis Web (TL12^)": {
                        location: 'any',
                        isHighEnergy: true,
                        cost: ['3M', '6M', '12M', '25M', '50M', '100M', '200M', '500M', '1B', '2B', '5B'],
                        desc: "Places the spacecraft inside a bubble of time that runs far slower than the rest of the universe. Effectively indestructible but unable to do anything but drift. Requires 1 Power Point."
                    },
                },
                "Weapons": {
                    "Major Battery (TL7)": {
                        location: 'hull',
                        isHighEnergy: true,
                        cost: ['150K', '600K', '1.5M', '6M', '15M', '60M', '150M', '600M', '1.5B', '6B', '15B'],
                        beam_output: [10, 30, 100, 300, 1000, 3000, 10000, 30000, 100000, 300000, 1000000], // MJ, GJ, TJ
                        gun_caliber: [10, 12, 14, 16, 20, 24, 28, 32, 40, 48, 56], // cm
                        launchers: [20, 24, 28, 32, 40, 48, 56, 64, 80, 96, 112], // cm
                        missile_shots: [7, 10, 15, 20, 30, 50, 70, 100, 150, 200, 300],
                        gun_shots: [70, 100, 150, 200, 300, 500, 700, 1000, 1500, 2000, 3000],
                        desc: "Single mount for a powerful weapon (beam, gun, or launcher). Includes targeting systems. Requires 1 Power Point."
                    },
                    "Medium Battery (TL7)": {
                        location: 'hull',
                        isHighEnergy: true,
                        cost: ['150K', '600K', '1.5M', '6M', '15M', '60M', '150M', '600M', '1.5B', '6B', '15B'],
                        beam_output: [3, 10, 30, 100, 300, 1000, 3000, 10000, 30000, 100000, 300000], // MJ, GJ
                        gun_caliber: [8, 10, 12, 14, 16, 20, 24, 28, 32, 40, 48], // cm
                        launchers: [16, 20, 24, 28, 32, 40, 48, 56, 64, 80, 96], // cm
                        missile_shots: [5, 7, 10, 15, 20, 30, 50, 70, 100, 300, 500],
                        gun_shots: [50, 70, 100, 150, 200, 300, 500, 700, 1000, 3000, 5000],
                        desc: "Less powerful than Major Battery. Up to three fixed or turret mounted weapons. Requires 1 Power Point."
                    },
                    "Secondary Battery (TL7)": {
                        location: 'hull',
                        isHighEnergy: true,
                        cost: [null, '600K', '1.5M', '6M', '15M', '60M', '150M', '600M', '1.5B', '6B', '15B'],
                        beam_output: [null, 3, 10, 30, 100, 300, 1000, 3000, 10000, 30000, 100000], // MJ, GJ
                        gun_caliber: [null, 8, 10, 12, 14, 16, 20, 24, 28, 32, 40], // cm
                        launchers: [null, 16, 20, 24, 28, 32, 40, 48, 56, 64, 80], // cm
                        missile_shots: [null, 5, 7, 10, 15, 20, 30, 50, 70, 100, 300],
                        gun_shots: [null, 50, 70, 100, 150, 200, 300, 500, 700, 1000, 3000],
                        desc: "Less powerful than Medium Battery. Up to 10 fixed or turret mounted weapons. Requires 1 Power Point."
                    },
                    "Tertiary Battery (TL7)": {
                        location: 'hull',
                        isHighEnergy: true,
                        cost: [null, null, '1.5M', '6M', '15M', '60M', '150M', '600M', '1.5B', '6B', '15B'],
                        beam_output: [null, null, 3, 10, 30, 100, 300, 1000, 3000, 10000, 30000], // MJ, GJ
                        gun_caliber: [null, null, 8, 10, 12, 14, 16, 20, 24, 28, 32], // cm
                        launchers: [null, null, 16, 20, 24, 28, 32, 40, 48, 56, 64], // cm
                        missile_shots: [null, null, 5, 7, 10, 15, 20, 30, 50, 70, 100],
                        gun_shots: [null, null, 50, 70, 100, 150, 200, 300, 500, 700, 1000],
                        desc: "Less powerful than Secondary Battery. Up to 30 fixed or turret mounted weapons. Requires 1 Power Point."
                    },
                    "Spinal Battery (TL7)": {
                        location: 'special', // Occupies Front, Central core, Rear
                        isHighEnergy: true,
                        cost: ['500K', '1.5M', '5M', '15M', '50M', '150M', '500M', '1.5B', '5B', '15B', '50B'],
                        beam_output: [30, 100, 300, 1000, 3000, 10000, 30000, 100000, 300000, 1000000, 3000000], // MJ, GJ, TJ
                        gun_caliber: [12, 14, 16, 20, 24, 28, 32, 40, 48, 56, 64], // cm
                        launchers: [24, 28, 32, 40, 48, 56, 64, 80, 96, 112, null], // cm
                        missile_shots: [7, 10, 15, 20, 30, 50, 70, 100, 150, 200, 300],
                        gun_shots: [70, 100, 150, 200, 300, 500, 700, 1000, 1500, 2000, 3000],
                        desc: "Single fixed mount for a beam weapon or gun that runs through the entire spacecraft. Is actually three systems (front, central core, rear). Requires 3 Power Points."
                    },
                }
            },
            rules: {
                "Space Travel": `
                    <h3 class="text-xl font-bold mb-2 text-skin-heading">Newtonian Space Flight & Delta-V</h3>
                    <p class="mb-4">The top speed of a spacecraft using a reaction drive (like a chemical or fusion rocket) is its "delta-V"—the maximum change in velocity it can perform before running out of fuel. Every acceleration or deceleration "costs" a fraction of this delta-V reserve.</p>
                    <h4 class="font-semibold text-skin-base">Key Delta-V requirements:</h4>
                    <ul class="list-disc list-inside space-y-1 mt-2 mb-4">
                        <li><strong>Reaching Low Orbit (from Earth):</strong> ~5.6 mps (and acceleration > 1G)</li>
                        <li><strong>Escaping Earth Orbit:</strong> ~2.1 mps (if already in orbit)</li>
                        <li><strong>Earth to Mars Transfer:</strong> ~12 mps (for a ~6-month trip)</li>
                    </ul>
                     <h3 class="text-xl font-bold mb-2 text-skin-heading">Reactionless Drives</h3>
                     <p>Drives like the Standard Reactionless Engine don't use fuel and can accelerate continuously, limited only by their power source. Their top speed is near-lightspeed. Travel time is calculated based on constant acceleration to a midpoint, followed by deceleration.</p>`,
                "Space Combat": `
                    <h3 class="text-xl font-bold mb-2 text-skin-heading">Hull Damage & Hit Location</h3>
                    <p class="mb-2">When a ship takes damage that penetrates its armor, the location of the hit determines which system is affected. Each hull section (Front, Central, Rear) has six numbered system slots. A d6 roll determines which slot is hit.</p>
                    <ul class="list-disc list-inside space-y-1 mt-2 mb-4">
                        <li><strong>Disabled System:</strong> A system becomes disabled if it takes penetrating damage equal to 10% of the ship's total dHP.</li>
                        <li><strong>Destroyed System:</strong> A system is destroyed if it takes penetrating damage equal to 50% of the ship's dHP, or if it was already disabled and is hit again.</li>
                        <li><strong>Core Systems:</strong> These are deep-buried systems and are not hit by random rolls. They can only be damaged by precision attacks or after all other systems in a section are destroyed.</li>
                    </ul>
                     <h3 class="text-xl font-bold font-bold mb-2 text-skin-heading">dDR and Armor</h3>
                     <p>Damage Resistance (dDR) is decade-scale. An attack's damage must exceed the combined dDR of any force screens and the armor on the specific hull section that was hit. Streamlined hulls have lower dDR for the same armor mass because it's spread over a larger surface area.</p>`
            },
            examples: [
                 {
                    name: "Star Flower-class Tramp Freighter (TL11^)",
                    sm: "SM+8",
                    desc: "A fast tramp freighter designed for operations in frontier regions. Its reactionless drive gives it enough thrust to blast off from a planetary planetary surface. It has a streamlined hull, masses 1,000 tons, and is 75 yards long.",
                    stats: { cost: "$44.5M", ddr: "7/7/7", accel: "2G/c", occ: "20 ASV" },
                    systems: {
                        front: ["Armor, Metallic Laminate (TL8)", "Cargo Hold (TL7)", "Cargo Hold (TL7)", "Cargo Hold (TL7)", "Enhanced Array (TL7)", "Cargo Hold (TL7)"],
                        central: ["Armor, Metallic Laminate (TL8)", "Habitat (TL7)", "Habitat (TL7)", "Cargo Hold (TL7)", "Cargo Hold (TL7)", "Tertiary Battery (TL7)"],
                        rear: ["Armor, Metallic Laminate (TL8)", "Reactionless Engine, Standard (TL10^)", "Reactionless Engine, Standard (TL10^)", "Stardrive Engine (TL^)", "Stardrive Engine (TL^)", "Engine Room (TL7)"],
                        core: ["Control Room (TL7)", "Power Plant, Fusion Reactor (TL9)"]
                    }
                },
                {
                    name: "Midnight Sun-class Orbital Shuttle (TL9)",
                    sm: "SM+6",
                    desc: "A two-stage spacecraft designed to lift a shuttle and crew from an Earth-gravity world into high orbit. This describes the 100-ton winged upper stage after it separates from its booster.",
                    stats: { cost: "$1.61M", ddr: "2/2/0", accel: "3G/+3.4 mps", occ: "2+12 SV" },
                    systems: {
                        front: ["Armor, Light Alloy (TL7)", "Control Room (TL7)", "Passenger Seating (TL7)", "Passenger Seating (TL7)", "Cargo Hold (TL7)", "Cargo Hold (TL7)"],
                        central: ["Armor, Light Alloy (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)"],
                        rear: ["Reaction Engine, Chemical Rocket (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)", "Fuel Tank (TL7)"],
                        core: ["Fuel Tank (TL7)", "Fuel Tank (TL7)"]
                    }
                }
            ]
        };

        // Application State
        let currentShip = {
            sm: "SM+8", // Initial default
            hullType: "unstreamlined", // Initial default
            slots: {
                front: Array(6).fill(null),
                central: Array(6).fill(null),
                rear: Array(6).fill(null),
                core: Array(2).fill(null)
            },
            stats: {}
        };
        let currentTL = 10; // Default Tech Level
        let selectedCategoryFilter = 'All';
        let superscienceEnabled = false; // New state variable for superscience toggle
        let isDirty = false; // Track unsaved changes

        let costChart = null;
        let performanceChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup
            initializeApp();

            // Event Listeners
            document.getElementById('hull-sm').addEventListener('change', handleConfigChange);
            document.getElementById('tech-level').addEventListener('change', handleConfigChange);
            document.querySelectorAll('input[name="hull-type"]').forEach(radio => {
                radio.addEventListener('change', handleConfigChange);
            });
            document.getElementById('superscience-toggle').addEventListener('change', handleConfigChange); // New event listener for superscience toggle
            document.getElementById('system-search').addEventListener('input', renderSystemCatalog);
            
            document.getElementById('modal-close').addEventListener('click', () => toggleModal('system-modal', false));

            // Export/Import buttons
            document.getElementById('export-ship-btn').addEventListener('click', exportShip);
            document.getElementById('import-ship-btn').addEventListener('click', () => toggleModal('import-modal', true));
            document.getElementById('export-modal-close').addEventListener('click', () => toggleModal('export-modal', false));
            document.getElementById('import-modal-close').addEventListener('click', () => toggleModal('import-modal', false));
            document.getElementById('perform-import-btn').addEventListener('click', importShip);
            document.getElementById('copy-json-btn').addEventListener('click', copyExportedJson);

            // Clear Ship button
            document.getElementById('clear-ship-btn').addEventListener('click', clearShip);
            document.getElementById('confirm-clear-save-btn').addEventListener('click', () => {
                toggleModal('confirm-clear-modal', false);
                exportShip(); // Export first
                initializeApp(); // Then clear
            });
            document.getElementById('confirm-clear-discard-btn').addEventListener('click', () => {
                toggleModal('confirm-clear-modal', false);
                initializeApp(); // Clear without saving
            });
            document.getElementById('confirm-clear-cancel-btn').addEventListener('click', () => {
                toggleModal('confirm-clear-modal', false); // Do nothing
            });


            // Navigation (main and side menu)
            const navItems = {
                'nav-shipyard': 'view-shipyard',
                'nav-rules': 'view-rules',
                'nav-examples': 'view-examples'
            };
            const sideNavItems = {
                'side-nav-shipyard': 'view-shipyard',
                'side-nav-rules': 'view-rules',
                'side-nav-examples': 'view-examples'
            };

            const activateNavItem = (navId) => {
                // Deactivate all main nav items
                document.querySelectorAll('.main-nav .nav-item').forEach(item => item.classList.remove('active'));
                // Deactivate all side nav items
                document.querySelectorAll('.side-menu .nav-item').forEach(item => item.classList.remove('active'));

                // Activate the corresponding main nav item if it exists
                if (document.getElementById(navId.replace('side-', ''))) {
                    document.getElementById(navId.replace('side-', '')).classList.add('active');
                }
                // Activate the corresponding side nav item if it exists
                if (document.getElementById(navId)) {
                    document.getElementById(navId).classList.add('active');
                }
                
                // Hide all views
                Object.values(navItems).forEach(viewId => document.getElementById(viewId).classList.add('hidden'));
                // Show the selected view
                document.getElementById(navItems[navId.replace('side-', '')] || sideNavItems[navId]).classList.remove('hidden');
            };

            Object.keys(navItems).forEach(navId => {
                document.getElementById(navId).addEventListener('click', () => activateNavItem(navId));
            });
            Object.keys(sideNavItems).forEach(navId => {
                document.getElementById(navId).addEventListener('click', () => {
                    activateNavItem(navId);
                    toggleSideMenu(false); // Close side menu after selection
                });
            });

            // Hamburger menu event listeners
            document.getElementById('hamburger-btn').addEventListener('click', () => toggleSideMenu(true));
            document.getElementById('side-menu-backdrop').addEventListener('click', () => toggleSideMenu(false));

            // Drag and Drop Listeners are now dynamically attached in renderBlueprint
        });

        function initializeApp() {
            // Set initial values from UI
            currentShip.sm = document.getElementById('hull-sm').value;
            currentShip.hullType = document.querySelector('input[name="hull-type"]:checked').value;
            currentTL = parseInt(document.getElementById('tech-level').value);
            superscienceEnabled = document.getElementById('superscience-toggle').checked;

            resetShipSlotsAndStats(); // Initialize with empty slots
            renderAll();
            populateRules();
            populateExamples();
            renderCategoryFilters();
            isDirty = false; // Reset dirty flag on initialization
        }
        
        // New function to only reset slots and stats, not configuration
        function resetShipSlotsAndStats() {
            currentShip.slots = {
                front: Array(6).fill(null),
                central: Array(6).fill(null),
                rear: Array(6).fill(null),
                core: Array(2).fill(null)
            };
            currentShip.stats = {}; // Clear stats
        }

        function renderAll() {
            renderSystemCatalog();
            renderBlueprint();
            recalculateStats();
        }

        function handleConfigChange() {
            currentShip.sm = document.getElementById('hull-sm').value;
            currentShip.hullType = document.querySelector('input[name="hull-type"]:checked').value;
            currentTL = parseInt(document.getElementById('tech-level').value);
            superscienceEnabled = document.getElementById('superscience-toggle').checked;
            
            resetShipSlotsAndStats(); // Only clear slots and stats here
            renderAll();
            isDirty = true; // Mark as dirty when config changes
        }

        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;

            value = value.replace('$', '').trim();
            const multiplier = { 'K': 1e3, 'M': 1e6, 'B': 1e9, 'T': 1e12 };
            const lastChar = value.slice(-1).toUpperCase();

            if (multiplier[lastChar]) {
                return parseFloat(value.slice(0, -1)) * multiplier[lastChar];
            }
            return parseFloat(value);
        }

        // Generic getter for SM-dependent properties (now arrays)
        function getSmDependentValue(systemData, propertyName, sm) {
            if (!systemData || !systemData[propertyName] || !Array.isArray(systemData[propertyName])) return 0;
            const index = smToIndex(sm);
            return systemData[propertyName][index] || 0;
        }

        function getSystemCost(systemData, sm) {
            return parseCurrency(getSmDependentValue(systemData, 'cost', sm));
        }

        function getSystemAccel(systemData, tl) {
            if (!systemData || !systemData.accel) return 0;
            if (typeof systemData.accel === 'object') {
                for (let t = tl; t >= 7; t--) {
                    if (systemData.accel[`TL${t}`] !== undefined) {
                        return systemData.accel[`TL${t}`];
                    }
                }
                return 0; // Default if TL not found
            }
            return systemData.accel;
        }

        function getSystemDeltaVPerTank(systemData, tl) {
            if (!systemData || !systemData.deltaV_per_tank) return 0;
            if (typeof systemData.deltaV_per_tank === 'object') {
                for (let t = tl; t >= 7; t--) {
                    if (systemData.deltaV_per_tank[`TL${t}`] !== undefined) {
                        return systemData.deltaV_per_tank[`TL${t}`];
                    }
                }
                return 0;
            }
            return systemData.deltaV_per_tank;
        }

        function getSystemDDR(systemData, sm, hullType) {
            if (!systemData || (!systemData.us_dDR && !systemData.sl_dDR)) return 0;
            if (hullType === 'streamlined' && systemData.sl_dDR) {
                return getSmDependentValue(systemData, 'sl_dDR', sm);
            }
            if (systemData.us_dDR) {
                return getSmDependentValue(systemData, 'us_dDR', sm);
            }
            return 0;
        }

        function getSystemArrayLevel(systemData, sm, tl) {
            if (!systemData || !systemData.array_level) return 0;
            const baseLevel = getSmDependentValue(systemData, 'array_level', sm);
            return tl + baseLevel;
        }

        // Function to extract TL and superscience flag from system name
        function parseSystemTL(systemName) {
            const tlMatch = systemName.match(/TL(\d+)/);
            const isSuperscience = systemName.includes('^');
            let baseTL = 7; // Default to TL7 if no specific TL number is found (e.g., "TL^")

            if (tlMatch && tlMatch[1]) {
                baseTL = parseInt(tlMatch[1], 10);
            } else if (isSuperscience) {
                // If it's a superscience system but no specific TL number (e.g., "TL^"), assume it's available from TL7
                baseTL = 7; // Or some other appropriate default for superscience-only TLs
            }

            return { baseTL, isSuperscience };
        }

        // New function to check system availability based on current TL and superscience toggle
        function isSystemAvailable(systemName, currentTL, superscienceEnabled) {
            const { baseTL, isSuperscience } = parseSystemTL(systemName);

            // Check if the current TL meets or exceeds the system's base TL
            if (currentTL < baseTL) {
                return false;
            }

            // If it's a superscience system, check if superscience is enabled
            if (isSuperscience && !superscienceEnabled) {
                return false;
            }

            return true;
        }

        // Render Functions
        function renderCategoryFilters() {
            const filtersEl = document.getElementById('category-filters');
            filtersEl.innerHTML = '';
            const categories = ['All', ...Object.keys(shipData.systems)];

            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `filter-button ${selectedCategoryFilter === category ? 'active' : ''}`;
                button.addEventListener('click', () => {
                    if (selectedCategoryFilter === category) {
                        selectedCategoryFilter = 'All'; // Toggle off
                    } else {
                        selectedCategoryFilter = category;
                    }
                    renderCategoryFilters();
                    renderSystemCatalog();
                });
                filtersEl.appendChild(button);
            });
        }

        function renderSystemCatalog() {
            const catalogEl = document.getElementById('system-catalog');
            const searchTerm = document.getElementById('system-search').value.toLowerCase();
            catalogEl.innerHTML = '';

            for (const category in shipData.systems) {
                if (selectedCategoryFilter !== 'All' && selectedCategoryFilter !== category) {
                    continue;
                }

                const systemsInCategory = shipData.systems[category];
                const filteredSystems = Object.keys(systemsInCategory).filter(sysName => 
                    sysName.toLowerCase().includes(searchTerm) && 
                    isSystemAvailable(sysName, currentTL, superscienceEnabled) // Apply new TL and superscience filter
                );

                if (filteredSystems.length > 0) {
                    const categoryEl = document.createElement('div');
                    let categoryHint = '';
                    // Determine category hint based on common system locations
                    if (category === 'Armor') {
                        categoryHint = ' (Hull Only)';
                    } else if (category === 'Propulsion') {
                        categoryHint = ' (Rear/Any)';
                    } else if (category === 'Control & Sensors' || category === 'Power' || category === 'Habitation & Life Support' || category === 'Special Systems') {
                        categoryHint = ' (Any/Hull)';
                    } else if (category === 'Weapons') {
                        categoryHint = ' (Hull/Special)';
                    } else if (category === 'Cargo & Storage') {
                        categoryHint = ' (Any)';
                    }
                    categoryEl.innerHTML = `<h3 class="font-bold text-lg text-skin-base sticky top-0 bg-skin-secondary py-1">${category}${categoryHint}</h3>`;
                    const listEl = document.createElement('ul');
                    listEl.className = 'pl-2 space-y-1';
                    
                    filteredSystems.forEach(sysName => {
                        const systemData = systemsInCategory[sysName];
                        const li = document.createElement('li');
                        li.textContent = sysName;
                        li.className = 'draggable-system';
                        li.draggable = true;
                        li.dataset.category = category;
                        li.dataset.systemName = sysName;
                        li.addEventListener('dragstart', handleDragStart);
                        listEl.appendChild(li);
                    });

                    categoryEl.appendChild(listEl);
                    catalogEl.appendChild(categoryEl);
                }
            }
        }
        
        function renderBlueprint() {
            const sections = {
                'blueprint-front': { name: 'Front Hull', slots: currentShip.slots.front, sectionKey: 'front' },
                'blueprint-central': { name: 'Central Hull', slots: currentShip.slots.central, sectionKey: 'central' },
                'blueprint-rear': { name: 'Rear Hull', slots: currentShip.slots.rear, sectionKey: 'rear' }
            };
            
            const createSlotElement = (sectionKey, index, isCore = false) => {
                const system = isCore ? currentShip.slots.core[index] : currentShip.slots[sectionKey][index];
                
                const slot = document.createElement('div');
                slot.className = `p-3 rounded-lg text-center flex items-center justify-center system-slot ${isCore ? 'core' : ''}`;
                slot.dataset.section = sectionKey;
                slot.dataset.index = index;
                if(isCore) slot.dataset.isCore = 'true';

                if (system) {
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <div class="w-full">
                            <p class="font-semibold text-sm text-skin-heading">${system.name}</p>
                            <button class="text-xs text-error hover:text-red-700 mt-1" onclick="event.stopPropagation(); removeSystem('${sectionKey}', ${index}, ${isCore});">Remove</button>
                        </div>
                    `;
                } else {
                    slot.innerHTML = `<span class="text-skin-muted text-sm">${isCore ? `Core Slot ${index+1}` : `Slot ${index+1}`}</span>`;
                }
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                return slot;
            };

            for (const id in sections) {
                const container = document.getElementById(id);
                container.innerHTML = '';

                const sectionData = sections[id];
                const sectionHeader = document.createElement('h3');
                sectionHeader.className = 'font-semibold text-skin-base mb-2';
                sectionHeader.textContent = sectionData.name;
                container.appendChild(sectionHeader);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';
                
                sectionData.slots.forEach((_, i) => {
                    grid.appendChild(createSlotElement(sectionData.sectionKey, i));
                });
                container.appendChild(grid);
            }
            
            const frontBlueprint = document.getElementById('blueprint-front');
            const coreSlotsTitle = document.createElement('h3');
            coreSlotsTitle.className = 'font-semibold text-skin-base mt-4 mb-2';
            coreSlotsTitle.textContent = 'Core Systems';
            frontBlueprint.appendChild(coreSlotsTitle);

            const coreGrid = document.createElement('div');
            coreGrid.className = 'grid grid-cols-2 gap-2';
            coreGrid.appendChild(createSlotElement('core', 0, true));
            coreGrid.appendChild(createSlotElement('core', 1, true));
            frontBlueprint.appendChild(coreGrid);
        }

        function recalculateStats() {
            let totalCost = 0, powerGenerated = 0, powerUsed = 0, ftlRating = 0;
            let totalAccel = 0, totalDeltaV = 0, numFuelTanks = 0;
            let ddr = { front: 0, central: 0, rear: 0 };
            let slotsFilled = 0;
            let costBreakdown = {};

            const sm = currentShip.sm;
            const hullType = currentShip.hullType;
            const tl = currentTL;

            const processSystem = (system, sectionName) => {
                if (!system) return;
                slotsFilled++;

                const category = system.category;
                const systemData = shipData.systems[category][system.name];

                if(!costBreakdown[category]) costBreakdown[category] = 0;
                const systemCost = getSystemCost(systemData, sm);
                totalCost += systemCost;
                costBreakdown[category] += systemCost;
                
                if(systemData.power) powerGenerated += systemData.power;
                if(systemData.isHighEnergy) powerUsed++;
                if(systemData.ftl) {
                    if (typeof systemData.ftl === 'object') {
                        // Assuming Super Stardrive can be FTL-1 or FTL-2 based on 1 or 2 PP.
                        // For calculation simplicity, we'll assume max FTL for now.
                        ftlRating += systemData.ftl[`TL${tl}`] || systemData.ftl['TL11'] || 0;
                    } else {
                        ftlRating += systemData.ftl;
                    }
                }

                if(category === 'Armor' && sectionName !== 'core') {
                    ddr[sectionName] += getSystemDDR(systemData, sm, hullType);
                }
                
                if(category === 'Propulsion') {
                    const accelVal = getSystemAccel(systemData, tl);
                    if (accelVal) totalAccel += accelVal;

                    if (system.name.includes("Fuel Tank")) {
                        numFuelTanks++;
                    }
                }
            };
            
            Object.keys(currentShip.slots).forEach(sectionName => {
                currentShip.slots[sectionName].forEach(system => processSystem(system, sectionName));
            });

            // Calculate Delta-V based on total fuel tanks and reaction engines
            let reactionEngineDeltaVPerTank = 0;
            let hasReactionEngine = false;
            for (const sectionName in currentShip.slots) {
                for (const system of currentShip.slots[sectionName]) {
                    if (system && system.category === 'Propulsion') {
                        const systemData = shipData.systems[system.category][system.name];
                        const dv_per = getSystemDeltaVPerTank(systemData, tl);
                        if (dv_per > 0) {
                            reactionEngineDeltaVPerTank = dv_per;
                            hasReactionEngine = true;
                            break;
                        }
                    }
                }
                if (hasReactionEngine) break;
            }

            if (hasReactionEngine) {
                totalDeltaV = reactionEngineDeltaVPerTank * numFuelTanks;
                // Apply Delta-V Increase from Fuel Tank Table (p.17) if 6 or more tanks
                if (numFuelTanks >= 6) {
                    let multiplier = 1;
                    if (numFuelTanks >= 6 && numFuelTanks <= 8) multiplier = 1.2;
                    else if (numFuelTanks >= 9 && numFuelTanks <= 12) multiplier = 1.4;
                    else if (numFuelTanks >= 13 && numFuelTanks <= 14) multiplier = 1.6;
                    else if (numFuelTanks === 15) multiplier = 1.8;
                    else if (numFuelTanks === 16) multiplier = 2;
                    else if (numFuelTanks === 17) multiplier = 2.2;
                    else if (numFuelTanks === 18) multiplier = 2.5;
                    else if (numFuelTanks === 19) multiplier = 3;
                    totalDeltaV *= multiplier;
                }
            }

            currentShip.stats = { totalCost, powerGenerated, powerUsed, ftlRating, totalAccel, totalDeltaV, ddr, costBreakdown };
            renderDashboard();
            document.getElementById('slots-filled-count').textContent = slotsFilled;
        }

        function renderDashboard() {
            const stats = currentShip.stats;
            document.getElementById('stat-cost').textContent = formatCurrency(stats.totalCost);
            const powerEl = document.getElementById('stat-power');
            powerEl.textContent = `${stats.powerUsed} / ${stats.powerGenerated}`;
            powerEl.classList.toggle('text-error', stats.powerUsed > stats.powerGenerated);
            powerEl.classList.toggle('text-success', stats.powerUsed <= stats.powerGenerated && stats.powerGenerated > 0);

            document.getElementById('stat-ddr').textContent = `${stats.ddr.front}/${stats.ddr.central}/${stats.ddr.rear}`;
            document.getElementById('stat-accel').textContent = `${stats.totalAccel.toFixed(2)} G`;
            document.getElementById('stat-deltav').textContent = `${stats.totalDeltaV.toFixed(1)} mps`;
            document.getElementById('stat-ftl').textContent = `${stats.ftlRating}x`;
            
            renderCharts();
        }
        
        function renderCharts() {
            const costCtx = document.getElementById('cost-chart').getContext('2d');
            const performanceCtx = document.getElementById('performance-chart').getContext('2d');

            const costData = currentShip.stats.costBreakdown || {};
            const costLabels = Object.keys(costData);
            const costValues = Object.values(costData);

            // Get computed styles for chart colors
            const computedStyle = getComputedStyle(document.body);
            const primaryAccentColor = computedStyle.getPropertyValue('--color-accent-secondary').trim();
            const secondaryAccentColor = computedStyle.getPropertyValue('--color-accent-primary').trim();
            const tertiaryBgColor = computedStyle.getPropertyValue('--color-bg-tertiary').trim();
            const primaryBgColor = computedStyle.getPropertyValue('--color-bg-primary').trim();


            if(costChart) costChart.destroy();
            costChart = new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: costLabels.length > 0 ? costLabels : ['No Systems'],
                    datasets: [{
                        label: 'Cost Breakdown',
                        data: costLabels.length > 0 ? costValues : [1],
                        backgroundColor: [ primaryAccentColor, secondaryAccentColor, computedStyle.getPropertyValue('--color-info').trim(), computedStyle.getPropertyValue('--color-error').trim(), computedStyle.getPropertyValue('--color-button-neutral-bg').trim(), '#14b8a6', '#60A5FA', '#FCD34D', '#F87171', '#A78BFA'],
                        borderColor: primaryBgColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                font: { size: 10 },
                                color: computedStyle.getPropertyValue('--color-text-base').trim() // Use CSS var for legend text color
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += formatCurrency(context.parsed); }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const { totalAccel, totalDeltaV, ddr, ftlRating } = currentShip.stats;
            // Normalize values for radar chart (0-100 scale)
            const maxAccel = 10; // e.g., 10G is a good max for radar chart
            const maxDeltaV = 1000; // e.g., 1000 mps is a good max
            const maxDDR = 100; // e.g., 100 avg dDR is a good max
            const maxFTL = 5; // e.g., FTL-5 is a good max

            const perfData = [
                Math.min(100, (totalAccel / maxAccel) * 100),
                Math.min(100, (totalDeltaV / maxDeltaV) * 100),
                Math.min(100, ((ddr.front + ddr.central + ddr.rear) / 3 / maxDDR) * 100),
                Math.min(100, (ftlRating / maxFTL) * 100)
            ];

            if(performanceChart) performanceChart.destroy();
            performanceChart = new Chart(performanceCtx, {
                type: 'radar',
                data: {
                    labels: ['Acceleration', 'Delta-V', 'Armor (Avg)', 'FTL'],
                    datasets: [{
                        label: 'Ship Performance Profile',
                        data: perfData,
                        fill: true,
                        backgroundColor: computedStyle.getPropertyValue('--color-accent-secondary').trim() + '33', /* Add transparency */
                        borderColor: primaryAccentColor,
                        pointBackgroundColor: primaryAccentColor,
                        pointBorderColor: primaryBgColor,
                        pointHoverBackgroundColor: primaryBgColor,
                        pointHoverBorderColor: primaryAccentColor
                    }]
                },
                options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                        r: {
                            angleLines: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { display: false },
                            pointLabels: {
                                color: computedStyle.getPropertyValue('--color-text-base').trim() // Use CSS var for radar labels
                            },
                            grid: {
                                color: computedStyle.getPropertyValue('--color-border-light').trim() // Use CSS var for grid lines
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function populateRules() {
            const container = document.getElementById('rules-content');
            container.innerHTML = '';
            for (const [title, content] of Object.entries(shipData.rules)) {
                 container.innerHTML += content;
            }
        }
        
        function populateExamples() {
            const container = document.getElementById('examples-content');
            container.innerHTML = '';
            shipData.examples.forEach((ship, index) => { // Added index here
                const shipEl = document.createElement('div');
                shipEl.className = 'border-t border-skin-light pt-6';
                let systemsHTML = '<div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 mt-3 text-sm">';
                
                const formatSection = (title, systemsList) => {
                    let html = `<div><h4 class="font-semibold text-skin-base">${title}</h4><ul class="list-disc list-inside">`;
                    systemsList.forEach(sys => { html += `<li>${sys}</li>` });
                    html += `</ul></div>`;
                    return html;
                }
                systemsHTML += formatSection('Front Hull', ship.systems.front);
                systemsHTML += formatSection('Central Hull', ship.systems.central);
                systemsHTML += formatSection('Rear Hull', ship.systems.rear);
                systemsHTML += formatSection('Core Systems', ship.systems.core);
                systemsHTML += '</div>';

                shipEl.innerHTML = `
                    <h3 class="text-xl font-semibold text-accent-secondary font-orbitron">${ship.name}</h3>
                    <p class="mt-1 text-skin-base">${ship.desc}</p>
                    <div class="flex flex-wrap gap-4 mt-3 text-sm">
                        <span><strong>SM:</strong> ${ship.sm}</span>
                        <span><strong>Cost:</strong> ${ship.stats.cost}</span>
                        <span><strong>dDR:</strong> ${ship.stats.ddr}</span>
                        <span><strong>Move:</strong> ${ship.stats.accel}</span>
                        <span><strong>Occ:</strong> ${ship.stats.occ}</span>
                    </div>
                    ${systemsHTML}
                    <button class="px-4 py-2 mt-4 bg-info text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-info" onclick="loadExampleShipTemplateByIndex(${index})">Load as Template</button>
                `;
                container.appendChild(shipEl);
            });
        }


        // Modal Logic
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.add('active');
            } else {
                modal.classList.remove('active');
            }
        }

        // Custom Message Box
        function showMessageBox(message) {
            const msgBox = document.getElementById('message-box');
            document.getElementById('message-box-text').textContent = message;
            msgBox.style.display = 'block';
        }

        // Drag and Drop Handlers
        let draggedSystemData = null;

        function handleDragStart(e) {
            draggedSystemData = {
                category: e.target.dataset.category,
                name: e.target.dataset.systemName
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedSystemData));
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            if (e.target.classList.contains('system-slot') && !e.target.classList.contains('filled')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');

            const targetSlot = e.target.closest('.system-slot');
            if (targetSlot && !targetSlot.classList.contains('filled')) {
                const section = targetSlot.dataset.section;
                const index = parseInt(targetSlot.dataset.index);
                const isCore = targetSlot.dataset.isCore === 'true';

                if (draggedSystemData) {
                    // Corrected argument order for addSystemToSlot
                    addSystemToSlot(draggedSystemData.category, draggedSystemData.name, section, index, isCore);
                }
            }
        }

        function addSystemToSlot(category, systemName, section, index, isCore) {
            const systemToAdd = {
                category: category,
                name: systemName
            };

            const systemDetails = shipData.systems[category][systemName];

            if (!systemDetails) {
                showMessageBox(`Error: System '${systemName}' not found in catalog. Cannot add.`);
                return;
            }

            // Special system checks (these are rules, not slot placement restrictions usually)
            if (systemName === "Spinal Battery (TL7)") {
                showMessageBox("Spinal Battery is a special system occupying 3 slots (Front, Central Core, Rear). Manual placement not supported via drag/drop for this system. Please add it manually to the appropriate slots if desired.");
                return;
            }
            if (systemName === "Upper Stage") {
                showMessageBox("Upper Stage is a spacecraft design rule, not a system that occupies a single slot. Please refer to the GURPS Spaceships rules for its implementation.");
                return;
            }
            // Force Screen: Check if one already exists
            if (systemName.includes("Force Screen")) {
                let forceScreenExists = false;
                for (const secKey in currentShip.slots) {
                    if (currentShip.slots[secKey].some(s => s && s.name.includes("Force Screen"))) {
                        forceScreenExists = true;
                        break;
                    }
                }
                if (forceScreenExists) {
                    showMessageBox("Only one Force Screen system can be installed on a spacecraft.");
                    return;
                }
            }

            // Location validation
            if (isCore) {
                // If trying to place in a Core slot
                if (systemDetails.location === 'hull' || systemDetails.location === 'front' || systemDetails.location === 'central' || systemDetails.location === 'rear' || systemDetails.location === 'special') {
                    showMessageBox(`System '${systemName}' (a ${category} system) cannot be placed in a Core slot. Core slots are for core-specific or 'any' location systems.`);
                    return;
                }
            } else { // If trying to place in a non-core slot (front, central, rear)
                if (systemDetails.location === 'core') {
                    showMessageBox(`System '${systemName}' (a ${category} system) must be placed in a Core slot.`);
                    return;
                }
                // Check if the system has a specific section location that doesn't match the target section
                if (systemDetails.location !== 'any' && systemDetails.location !== 'hull' && systemDetails.location !== section) {
                    showMessageBox(`System '${systemName}' (a ${category} system) cannot be placed in the ${section} hull. It requires an 'any', 'hull', or '${systemDetails.location}' location.`);
                    return;
                }
            }

            // If all validations pass, add the system
            if (isCore) {
                currentShip.slots.core[index] = systemToAdd;
            } else {
                currentShip.slots[section][index] = systemToAdd;
            }
            renderAll();
            isDirty = true; // Mark as dirty when a system is added
        }
        
        function removeSystem(section, index, isCore) {
             if (isCore) {
                currentShip.slots.core[index] = null;
            } else {
                currentShip.slots[section][index] = null;
            }
            renderAll();
            isDirty = true; // Mark as dirty when a system is removed
        }

        // Utility Functions
        function formatCurrency(num) {
            if (num === null || isNaN(num)) return '$N/A';
            if (num >= 1e12) return `$${(num/1e12).toFixed(1)}T`;
            if (num >= 1e9) return `$${(num/1e9).toFixed(1)}B`;
            if (num >= 1e6) return `$${(num/1e6).toFixed(1)}M`;
            if (num >= 1e3) return `$${(num/1e3).toFixed(1)}K`;
            return `$${num.toFixed(0)}`;
        }

        // Export/Import Functions
        function exportShip() {
            const exportedSystems = [];
            Object.keys(currentShip.slots).forEach(sectionKey => {
                currentShip.slots[sectionKey].forEach((systemInSlot, index) => {
                    if (systemInSlot) {
                        const originalSystemData = shipData.systems[systemInSlot.category][systemInSlot.name];
                        const explicitSystemDetails = { ...originalSystemData }; // Shallow copy

                        // Convert array-based SM properties back to dictionaries for export
                        for (const prop of SM_DEPENDENT_PROPERTIES) {
                            if (explicitSystemDetails[prop] && Array.isArray(explicitSystemDetails[prop])) {
                                explicitSystemDetails[prop] = convertSmArrayToDict(explicitSystemDetails[prop]);
                            }
                        }

                        exportedSystems.push({
                            section: sectionKey,
                            index: index,
                            category: systemInSlot.category,
                            name: systemInSlot.name,
                            details: explicitSystemDetails
                        });
                    }
                });
            });

            const exportData = {
                sm: currentShip.sm,
                tl: currentTL,
                hullType: currentShip.hullType,
                superscienceEnabled: superscienceEnabled,
                systems: exportedSystems // Now contains full, explicit system data
            };
            const jsonString = JSON.stringify(exportData, null, 2);
            document.getElementById('export-json-textarea').value = jsonString;
            toggleModal('export-modal', true);
            isDirty = false; // Reset dirty flag after export
        }

        function copyExportedJson() {
            const textarea = document.getElementById('export-json-textarea');
            textarea.select();
            document.execCommand('copy'); // Deprecated but works in iframes
            showMessageBox('Ship design JSON copied to clipboard!');
            toggleModal('export-modal', false);
        }

        function importShip() {
            const textarea = document.getElementById('import-json-textarea');
            const jsonString = textarea.value;
            try {
                const importedData = JSON.parse(jsonString);

                // Basic validation for required properties
                if (!importedData.sm || !importedData.tl || !importedData.hullType || !importedData.systems) {
                    throw new Error('Invalid ship design format. Missing core properties.');
                }

                // Update UI elements first
                document.getElementById('hull-sm').value = importedData.sm;
                document.getElementById('tech-level').value = importedData.tl;
                document.querySelector(`input[name="hull-type"][value="${importedData.hullType}"]`).checked = true;
                document.getElementById('superscience-toggle').checked = importedData.superscienceEnabled || false; // Default to false if not present

                // Update global state variables from the updated UI elements
                currentShip.sm = document.getElementById('hull-sm').value;
                currentShip.hullType = document.querySelector('input[name="hull-type"]:checked').value;
                currentTL = parseInt(document.getElementById('tech-level').value);
                superscienceEnabled = document.getElementById('superscience-toggle').checked;
                
                resetShipSlotsAndStats(); // Clear existing slots based on new config

                // Populate slots from imported systems
                importedData.systems.forEach(importedSystem => {
                    const isCore = importedSystem.section === 'core';
                    // Call addSystemToSlot, which will re-validate and add the system using internal data
                    addSystemToSlot(importedSystem.category, importedSystem.name, importedSystem.section, importedSystem.index, isCore);
                });

                renderAll();
                toggleModal('import-modal', false);
                showMessageBox('Ship design imported successfully!');
                isDirty = false; // Reset dirty flag after import

            } catch (e) {
                showMessageBox('Error importing ship design: ' + e.message);
                console.error('Error importing ship design:', e);
            }
        }

        // Function to handle clearing the ship
        function clearShip() {
            if (isDirty) {
                toggleModal('confirm-clear-modal', true);
            } else {
                initializeApp(); // Directly initialize if no changes
                showMessageBox('Ship blueprint cleared!');
            }
        }

        // New function to load example ship by index
        function loadExampleShipTemplateByIndex(index) {
            const exampleShip = shipData.examples[index];
            if (!exampleShip) {
                showMessageBox("Error: Example ship not found.");
                return;
            }

            // Determine TL and superscience from example name *before* updating UI
            const tlMatch = exampleShip.name.match(/TL(\d+)/);
            let exampleTL = currentTL; // Default to current TL
            if (tlMatch && tlMatch[1]) {
                exampleTL = parseInt(tlMatch[1], 10);
            }
            const isSuperscienceExample = exampleShip.name.includes('^');
            const exampleHullType = exampleShip.desc.toLowerCase().includes('streamlined hull') ? 'streamlined' : 'unstreamlined';

            // --- IMPORTANT: Update global state variables *before* setting UI elements ---
            // This ensures that when renderSystemCatalog and addSystemToSlot are called,
            // they use the correct TL and superscience context for the example ship.
            currentShip.sm = exampleShip.sm;
            currentShip.hullType = exampleHullType;
            currentTL = exampleTL;
            superscienceEnabled = isSuperscienceExample;

            // Now update UI elements to reflect the new state
            document.getElementById('hull-sm').value = currentShip.sm;
            document.getElementById('tech-level').value = currentTL;
            document.querySelector(`input[name="hull-type"][value="${currentShip.hullType}"]`).checked = true;
            document.getElementById('superscience-toggle').checked = superscienceEnabled;
            
            resetShipSlotsAndStats(); // Clear existing slots based on new config

            // Populate slots from imported systems
            for (const sectionKey in exampleShip.systems) {
                if (currentShip.slots[sectionKey]) {
                    exampleShip.systems[sectionKey].forEach((sysName, idx) => { // Use idx for index
                        let foundSystem = null;
                        for (const category in shipData.systems) {
                            if (shipData.systems[category][sysName]) {
                                foundSystem = { category: category, name: sysName };
                                break;
                            }
                        }
                        if (foundSystem) {
                            const isCore = sectionKey === 'core';
                            // This addSystemToSlot call will now use the correct currentTL and superscienceEnabled
                            // because they were updated at the beginning of this function.
                            // Corrected argument order for addSystemToSlot
                            addSystemToSlot(foundSystem.category, foundSystem.name, sectionKey, idx, isCore); 
                        } else {
                            console.warn(`System '${sysName}' not found in shipData for example ship.`);
                        }
                    });
                }
            }
            
            renderAll();
            showMessageBox(`"${exampleShip.name}" loaded as a template!`);
            isDirty = false; // Loading a template is a fresh state
            // Switch to shipyard view
            document.getElementById('nav-shipyard').click();
        }

        // Side menu toggle function
        function toggleSideMenu(show) {
            const sideMenu = document.getElementById('side-menu');
            const backdrop = document.getElementById('side-menu-backdrop');
            if (show) {
                sideMenu.classList.add('active');
                backdrop.classList.add('active');
            } else {
                sideMenu.classList.remove('active');
                backdrop.classList.remove('active');
            }
        }

    </script>
</body>
</html>
